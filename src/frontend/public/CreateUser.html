<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeltaΔPay - Create User Account</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <header class="header">
        <div class="logo">
            <svg viewBox="0 0 120 120">
                <line x1="9" y1="102" x2="62" y2="17" stroke="#AB92BF" stroke-width="5"/>
                <line x1="11" y1="102" x2="108" y2="102" stroke="#AB92BF" stroke-width="2.5"/>
                <line x1="64" y1="14" x2="112" y2="101" stroke="#AB92BF" stroke-width="10"/>
            </svg>
        </div>
        <div class="logo-container">
            <span class="logo-text">DeltaΔPay</span>
        </div>
        <div class="tagline">Admin — Create User Account</div>
    </header>

    <main class="main-container" style="align-items: center; justify-content: center; min-height: calc(100vh - 120px);">
        <div class="payment-container" style="max-width: 900px; width: 100%;">
            <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>
            
            <div class="payment-header" style="display:flex; align-items:center; justify-content:space-between; gap:1rem;">
                <div class="payment-title">Create New User Account</div>
                <a href="/view-payments" class="btn-back" style="position:static; margin:0; text-decoration:none; display:inline-block;">← Back to Admin</a>
            </div>

            <form id="createUserForm" class="payment-form">
                <!-- Personal Information -->
                <div class="form-section">
                    <h3 class="section-title">Personal Information</h3>
                    
                    <div class="form-group">
                        <label class="form-label" for="fullName">Full Name *</label>
                        <input type="text" id="fullName" name="fullName" class="form-input" 
                               placeholder="John Smith" required pattern="[a-zA-Z\s]{2,50}"
                               title="Only letters and spaces, 2-50 characters">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="idNumber">ID Number *</label>
                            <input type="text" id="idNumber" name="idNumber" class="form-input" 
                                   placeholder="8501011234567" required pattern="[0-9]{13}"
                                   title="Must be exactly 13 digits" maxlength="13">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="dateOfBirth">Date of Birth *</label>
                            <input type="date" id="dateOfBirth" name="dateOfBirth" class="form-input" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="nationality">Nationality *</label>
                            <input type="text" id="nationality" name="nationality" class="form-input" 
                                   placeholder="American" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="occupation">Occupation</label>
                            <input type="text" id="occupation" name="occupation" class="form-input" 
                                   placeholder="Software Engineer">
                        </div>
                    </div>
                </div>

                <!-- Account Information -->
                <div class="form-section">
                    <h3 class="section-title">Account Information</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="username">Username *</label>
                            <input type="text" id="username" name="username" class="form-input" 
                                   placeholder="johnsmith" required pattern="[a-zA-Z0-9_]{3,20}"
                                   title="3-20 characters, letters, numbers, underscore only">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="accountNumber">Account Number *</label>
                            <input type="text" id="accountNumber" name="accountNumber" class="form-input" 
                                   placeholder="1234567890123456" required pattern="[0-9]{10,20}"
                                   title="10-20 digits" maxlength="20">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="password">Password *</label>
                            <input type="password" id="password" name="password" class="form-input" 
                                   placeholder="Min 8 chars, 1 uppercase, 1 number, 1 special" required
                                   pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$"
                                   title="Min 8 chars with uppercase, lowercase, number, and special character">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="confirmPassword">Confirm Password *</label>
                            <input type="password" id="confirmPassword" name="confirmPassword" class="form-input" 
                                   placeholder="Re-enter password" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="accountType">Account Type *</label>
                            <select id="accountType" name="accountType" class="form-input" required>
                                <option value="Standard">Standard</option>
                                <option value="Premium">Premium</option>
                                <option value="Business">Business</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="currency">Currency *</label>
                            <select id="currency" name="currency" class="form-input" required>
                                <option value="ZAR" selected>ZAR - South African Rand</option>
                                <option value="USD">USD - US Dollar</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="GBP">GBP - British Pound</option>
                                <option value="AUD">AUD - Australian Dollar</option>
                                <option value="CAD">CAD - Canadian Dollar</option>
                                <option value="CHF">CHF - Swiss Franc</option>
                                <option value="JPY">JPY - Japanese Yen</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="accountBalance">Initial Balance *</label>
                            <input type="number" id="accountBalance" name="accountBalance" class="form-input" 
                                   placeholder="0.00" required min="0" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="annualIncome">Annual Income</label>
                            <input type="number" id="annualIncome" name="annualIncome" class="form-input" 
                                   placeholder="0" min="0" step="1" value="0">
                        </div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="form-section">
                    <h3 class="section-title">Contact Information</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="email">Email Address *</label>
                            <input type="email" id="email" name="email" class="form-input" 
                                   placeholder="john.smith@email.com" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="phoneNumber">Phone Number *</label>
                            <input type="tel" id="phoneNumber" name="phoneNumber" class="form-input" 
                                   placeholder="+1-555-0101" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="addressLine1">Address Line 1 *</label>
                        <input type="text" id="addressLine1" name="addressLine1" class="form-input" 
                               placeholder="123 Main Street" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="addressLine2">Address Line 2</label>
                        <input type="text" id="addressLine2" name="addressLine2" class="form-input" 
                               placeholder="Apt 4B">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="city">City *</label>
                            <input type="text" id="city" name="city" class="form-input" 
                                   placeholder="New York" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="stateProvince">State/Province *</label>
                            <input type="text" id="stateProvince" name="stateProvince" class="form-input" 
                                   placeholder="New York" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="postalCode">Postal Code *</label>
                            <input type="text" id="postalCode" name="postalCode" class="form-input" 
                                   placeholder="10001" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="country">Country *</label>
                            <input type="text" id="country" name="country" class="form-input" 
                                   placeholder="United States" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="preferredLanguage">Preferred Language</label>
                        <input type="text" id="preferredLanguage" name="preferredLanguage" class="form-input" 
                               placeholder="English" value="English">
                    </div>
                </div>

                <!-- Payment Card Information -->
                <div class="form-section">
                    <h3 class="section-title">Payment Card Information</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="cardNumber">Card Number *</label>
                            <input type="text" id="cardNumber" name="cardNumber" class="form-input" 
                                   placeholder="4532123456789012" required pattern="[0-9]{16}"
                                   title="Must be 16 digits" maxlength="16">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="cardExpiry">Card Expiry *</label>
                            <input type="text" id="cardExpiry" name="cardExpiry" class="form-input" 
                                   placeholder="MM/YY" required pattern="(0[1-9]|1[0-2])\/[0-9]{2}"
                                   title="Format: MM/YY" maxlength="5">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cardHolderName">Cardholder Name *</label>
                        <input type="text" id="cardHolderName" name="cardHolderName" class="form-input" 
                               placeholder="John Smith" required>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="form-section">
                    <button type="submit" class="submit-button ready" id="submitBtn">
                        <div class="button-content">
                            <span class="button-text">Create User Account</span>
                        </div>
                    </button>
                    <p class="security-note" style="text-align: center; margin-top: 1rem;">
                        * Required fields. All data is encrypted and securely stored.
                    </p>
                </div>
            </form>
        </div>
    </main>

    <script src="js/main.js"></script>
    <script>
        // Form validation and submission handling
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('createUserForm');
            const backBtn = document.getElementById('backToAdminBtn');

            if (backBtn) {
                backBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    globalThis.location.href = '/view-payments';
                });
            }

            if (form) {
                // Real-time password match validation
                const password = document.getElementById('password');
                const confirmPassword = document.getElementById('confirmPassword');

                confirmPassword.addEventListener('input', () => {
                    if (password.value !== confirmPassword.value) {
                        confirmPassword.setCustomValidity('Passwords do not match');
                    } else {
                        confirmPassword.setCustomValidity('');
                    }
                });

                // Format card expiry as user types
                const cardExpiry = document.getElementById('cardExpiry');
                cardExpiry.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.slice(0, 2) + '/' + value.slice(2, 4);
                    }
                    e.target.value = value;
                });

                // Format ID number - only digits
                const idNumber = document.getElementById('idNumber');
                idNumber.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/\D/g, '');
                });

                // Format account number - only digits
                const accountNumber = document.getElementById('accountNumber');
                accountNumber.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/\D/g, '');
                });

                // Format card number - only digits
                const cardNumber = document.getElementById('cardNumber');
                cardNumber.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/\D/g, '');
                });

                // Auto-fill cardholder name from full name
                const fullName = document.getElementById('fullName');
                const cardHolderName = document.getElementById('cardHolderName');
                fullName.addEventListener('blur', () => {
                    if (!cardHolderName.value && fullName.value) {
                        cardHolderName.value = fullName.value;
                    }
                });

                // Form submission
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    // Validate passwords match
                    if (password.value !== confirmPassword.value) {
                        showToast('Passwords do not match', 'error');
                        return;
                    }

                    const submitBtn = document.getElementById('submitBtn');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<div class="button-content"><span class="button-text">Creating Account...</span></div>';

                    try {
                        const formData = {
                            fullName: document.getElementById('fullName').value.trim(),
                            idNumber: document.getElementById('idNumber').value.trim(),
                            accountNumber: document.getElementById('accountNumber').value.trim(),
                            username: document.getElementById('username').value.trim(),
                            password: document.getElementById('password').value,
                            email: document.getElementById('email').value.trim(),
                            phoneNumber: document.getElementById('phoneNumber').value.trim(),
                            dateOfBirth: document.getElementById('dateOfBirth').value,
                            nationality: document.getElementById('nationality').value.trim(),
                            addressLine1: document.getElementById('addressLine1').value.trim(),
                            addressLine2: document.getElementById('addressLine2').value.trim(),
                            city: document.getElementById('city').value.trim(),
                            stateProvince: document.getElementById('stateProvince').value.trim(),
                            postalCode: document.getElementById('postalCode').value.trim(),
                            country: document.getElementById('country').value.trim(),
                            accountBalance: parseFloat(document.getElementById('accountBalance').value) || 0,
                            currency: document.getElementById('currency').value,
                            accountType: document.getElementById('accountType').value,
                            preferredLanguage: document.getElementById('preferredLanguage').value.trim() || 'English',
                            occupation: document.getElementById('occupation').value.trim() || 'Unspecified',
                            annualIncome: parseFloat(document.getElementById('annualIncome').value) || 0,
                            cardNumber: document.getElementById('cardNumber').value.trim(),
                            cardExpiry: document.getElementById('cardExpiry').value.trim(),
                            cardHolderName: document.getElementById('cardHolderName').value.trim()
                        };

                        const response = await fetch('/api/admin/users/create', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formData)
                        });

                        const result = await response.json();

                        if (result.success) {
                            showToast('✅ User account created successfully!', 'success', 3000);
                            setTimeout(() => {
                                window.location.href = '/view-payments';
                            }, 2000);
                        } else {
                            throw new Error(result.message || 'Failed to create user');
                        }
                    } catch (error) {
                        console.error('User creation error:', error);
                        showToast(error.message || 'Failed to create user account', 'error');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<div class="button-content"><span class="button-text">Create User Account</span></div>';
                    }
                });
            }
        });
    </script>
</body>
</html>
